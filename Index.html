<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор вопросов SAT</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Светло-голубовато-серый фон */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }
        .section-title {
            border-bottom: 2px solid #cbd5e1;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .question-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        .question-passage {
            font-style: italic;
            color: #4a5568;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .question-text {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #2d3748;
        }
        .option-item {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            border: 1px solid transparent;
            font-size: 1rem;
        }
        .option-item:hover:not(.disabled) {
            background-color: #f3f4f6;
        }
        .option-item.correct {
            background-color: #d1fae5;
            border-color: #34d399;
            font-weight: 500;
        }
        .option-item.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            font-weight: 500;
        }
        .option-item.disabled {
            pointer-events: none;
            opacity: 0.8;
            cursor: default;
        }
        .explanation {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #e2e8f0;
            font-size: 0.9rem;
            color: #4a5568;
        }
        .login-container {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .login-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .login-button {
            width: 100%;
            background-color: #4299e1;
            color: white;
            font-weight: bold;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .login-button:hover {
            background-color: #3182ce;
        }
        .error-message {
            color: #ef4444;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #94a3b8;
        }
        .tooltip-text {
            visibility: hidden;
            width: auto;
            max-width: 500px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            word-wrap: break-word;
            font-size: 0.85rem;
            pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Вход в Генератор вопросов SAT</h2>
        <input type="password" id="passwordInput" class="login-input" placeholder="Введите пароль">
        <button id="loginBtn" class="login-button">Войти</button>
        <p id="loginError" class="error-message" style="display: none;">Неверный пароль. Попробуйте снова.</p>
    </div>

    <div id="appContent" class="container" style="display: none;">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Генератор вопросов SAT (Verbal Section)</h1>

        <div id="mainControls" class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-grow">
                <label for="difficultySelect" class="block text-gray-700 text-sm font-bold mb-2">Выберите уровень сложности:</label>
                <select id="difficultySelect" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                    <option value="easy" selected>Облегченный уровень (Easier Module)</option>
                    <option value="hard">Усложненный уровень (Harder Module 2)</option>
                </select>
            </div>
            <div class="flex-grow flex flex-col justify-end gap-2">
                <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    Сгенерировать вопросы
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading-indicator text-center" style="display: none;">
            <!-- Индикатор загрузки и сообщения будут здесь -->
        </div>

        <div id="questionsContainer" class="space-y-10">
            <!-- Вопросы будут загружены здесь -->
        </div>
        
        <div id="quizControls" class="mt-8 flex flex-col sm:flex-row justify-between gap-4">
            <button id="nextBtn" class="w-full sm:w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75" style="display: none;">
                Следующий вопрос
            </button>
            <button id="startNewTestBtn" class="w-full sm:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75" style="display: none;">
                Начать новый тест
            </button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from 'https://esm.sh/@google/generative-ai';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const apiKey = ""; 

        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-05-20" });

        const loginScreen = document.getElementById('loginScreen');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const appContent = document.getElementById('appContent');
        const questionsContainer = document.getElementById('questionsContainer');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const difficultySelect = document.getElementById('difficultySelect');
        const nextBtn = document.getElementById('nextBtn');
        const startNewTestBtn = document.getElementById('startNewTestBtn');

        const CORRECT_PASSWORD = "Jaleel2010";

        const categories = {
            "Information and Ideas": "information_ideas",
            "Craft and Structure": "craft_structure",
            "Expression of Ideas": "expression_ideas",
            "Standard English Conventions": "standard_english_conventions"
        };
        
        let allGeneratedQuestions = {};
        let categoriesArray = Object.keys(categories);
        let currentCategoryIndex = 0;
        let currentQuestionIndex = 0;
        let score = 0;
        let isQuizActive = false;

        function toRoman(num) {
            if (typeof num !== 'number' || num <= 0) return '';
            const romanNumerals = [{ value: 1000, symbol: 'M' }, { value: 900, symbol: 'CM' }, { value: 500, symbol: 'D' }, { value: 400, symbol: 'CD' }, { value: 100, symbol: 'C' }, { value: 90, symbol: 'XC' }, { value: 50, symbol: 'L' }, { value: 40, symbol: 'XL' }, { value: 10, symbol: 'X' }, { value: 9, symbol: 'IX' }, { value: 5, symbol: 'V' }, { value: 4, symbol: 'IV' }, { value: 1, symbol: 'I' }];
            let result = '';
            for (let i = 0; i < romanNumerals.length; i++) {
                while (num >= romanNumerals[i].value) {
                    result += romanNumerals[i].symbol;
                    num -= romanNumerals[i].value;
                }
            }
            return result;
        }

        function showCustomMessage(message) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50';
            modalOverlay.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                    <p class="text-lg font-semibold mb-4">${message}</p>
                    <button id="messageOk" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">OK</button>
                </div>
            `;
            document.body.appendChild(modalOverlay);
            document.getElementById('messageOk').addEventListener('click', () => {
                document.body.removeChild(modalOverlay);
            });
        }
        
        loginBtn.addEventListener('click', () => {
            if (passwordInput.value.trim() === CORRECT_PASSWORD) {
                loginScreen.style.display = 'none';
                appContent.style.display = 'block';
                loginError.style.display = 'none';
            } else {
                loginError.style.display = 'block';
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });

        function showLoading(message) {
            questionsContainer.innerHTML = '';
            loadingIndicator.innerHTML = `
                <p class="text-xl font-semibold mb-4 text-gray-700">${message}</p>
                <div class="mt-4">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900 mx-auto"></div>
                </div>
            `;
            loadingIndicator.style.display = 'block';
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            nextBtn.style.display = 'none';
            startNewTestBtn.style.display = 'none';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
            loadingIndicator.innerHTML = '';
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function generateQuestionsForCategory(categoryTitle, difficulty, retries = 0) {
            const MAX_RETRIES = 3;
            const BASE_DELAY_MS = 1000;
            const numberOfQuestions = 4;

            const prompt = `
                Generate a JSON array with exactly ${numberOfQuestions} unique and diverse SAT-style questions for the "${categoryTitle}" category. The difficulty should be suitable for a ${difficulty === 'hard' ? 'harder module' : 'easier module'}.
                
                For each question, provide:
                1.  "passage": A short, academic passage in English.
                2.  "question": A multiple-choice question in English based on the passage.
                3.  "options": An array of four option objects (A, B, C, D), each with a "label" and "text" in English.
                4.  "correct_answer": The label of the correct option (e.g., "A").
                5.  "explanation": A brief explanation in Russian.
                6.  "vocabulary": An array of 4-5 objects. Each has a "word", Russian "translation", and Russian "explanation".

                For "Craft and Structure" questions, one word or phrase in the passage should be enclosed in double asterisks, like **word**.
                For "Standard English Conventions" questions, the grammatically incorrect part should be enclosed in double asterisks, like **incorrect part**.

                Provide only the JSON array.
            `;

            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        passage: { type: "STRING" },
                        question: { type: "STRING" },
                        options: {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "label": { "type": "STRING" },
                                    "text": { "type": "STRING" }
                                },
                                "required": ["label", "text"]
                            }
                        },
                        "correct_answer": { "type": "STRING" },
                        "explanation": { "type": "STRING" },
                        "vocabulary": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "word": { "type": "STRING" },
                                    "translation": { "type": "STRING" },
                                    "explanation": { "type": "STRING" }
                                },
                                "required": ["word", "translation", "explanation"]
                            }
                        }
                    },
                    "required": ["passage", "question", "options", "correct_answer", "explanation", "vocabulary"]
                }
            };
            
            try {
                const result = await model.generateContent({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                });

                const rawResponse = result?.response?.text();
                if (!rawResponse || rawResponse.trim() === '') {
                    throw new Error("API returned an empty response.");
                }

                // Robust JSON parsing to handle potential model quirks
                const jsonMatch = rawResponse.match(/\[.*?\]/s);
                if (!jsonMatch) {
                    throw new Error("Could not find a valid JSON array in the API response.");
                }
                const cleanedResponse = jsonMatch[0];
                const questionsArray = JSON.parse(cleanedResponse);

                if (!Array.isArray(questionsArray) || questionsArray.length !== numberOfQuestions) {
                    throw new Error("API returned an incorrect number of questions or non-array format.");
                }
                return questionsArray;
            } catch (error) {
                console.error(`Error generating questions for ${categoryTitle}:`, error);
                if (retries < MAX_RETRIES) {
                    const delay = BASE_DELAY_MS * Math.pow(2, retries) + (Math.random() * 500);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateQuestionsForCategory(categoryTitle, difficulty, retries + 1);
                }
                loadingIndicator.innerHTML = `<p class='text-red-600'>Произошла ошибка при генерации вопросов для категории "${categoryTitle}". Пожалуйста, попробуйте еще раз. Ошибка: ${error.message}</p>`;
                hideLoading();
                return null;
            }
        }
        
        function createQuestionCard(questionData, categoryTitle, questionNumber, isFinalReview = false) {
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            
            const categoryHeader = document.createElement('h3');
            categoryHeader.className = 'text-xl font-semibold text-gray-700 mb-2';
            categoryHeader.textContent = `${toRoman(categoriesArray.indexOf(categoryTitle) + 1)}. ${categoryTitle}`;
            questionCard.appendChild(categoryHeader);

            let passageContent = questionData.passage;
            if (questionData.vocabulary) {
                questionData.vocabulary.forEach(vocabItem => {
                    const regex = new RegExp(`\\b${vocabItem.word}\\b`, 'gi');
                    passageContent = passageContent.replace(regex, (matchedWord) => {
                        const formattedWordInTooltip = `<strong>${matchedWord.charAt(0).toUpperCase() + matchedWord.slice(1)}</strong>`;
                        return `<span class="tooltip-container">${matchedWord}<span class="tooltip-text">${formattedWordInTooltip}: ${vocabItem.translation}: ${vocabItem.explanation}</span></span>`;
                    });
                });
            }

            if (categoryTitle === "Craft and Structure") {
                passageContent = passageContent.replace(/\*\*(.*?)\*\*/g, `<span class="font-bold underline">$1</span>`);
            } else if (categoryTitle === "Standard English Conventions") {
                passageContent = passageContent.replace(/\*\*(.*?)\*\*/g, `<span class="font-bold underline text-red-600">$1</span>`);
            }

            const passageDiv = document.createElement('div');
            passageDiv.className = 'question-passage';
            passageDiv.innerHTML = passageContent;

            const questionTextDiv = document.createElement('div');
            questionTextDiv.className = 'question-text';
            questionTextDiv.textContent = `Question ${questionNumber}: ${questionData.question}`;

            const optionsList = document.createElement('div');
            optionsList.className = 'options-list';

            questionData.options.forEach(option => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item px-4';
                optionItem.textContent = `${option.label}) ${option.text}`;
                optionItem.dataset.label = option.label;

                if (isFinalReview) {
                    optionItem.classList.add('disabled');
                    if (option.label === questionData.correct_answer) {
                        optionItem.classList.add('correct');
                    }
                    if (questionData.selectedAnswer === option.label && option.label !== questionData.correct_answer) {
                        optionItem.classList.add('incorrect');
                    }
                } else {
                    optionItem.addEventListener('click', () => {
                        const selectedLabel = optionItem.dataset.label;
                        questionData.selectedAnswer = selectedLabel;

                        if (selectedLabel === questionData.correct_answer) {
                            optionItem.classList.add('correct');
                            score++;
                        } else {
                            optionItem.classList.add('incorrect');
                            const correctAnswerElement = questionsContainer.querySelector(`[data-label="${questionData.correct_answer}"]`);
                            if (correctAnswerElement) {
                                correctAnswerElement.classList.add('correct');
                            }
                        }
                        
                        questionsContainer.querySelectorAll('.option-item').forEach(opt => opt.classList.add('disabled'));
                        
                        nextBtn.style.display = 'block';
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                }
                optionsList.appendChild(optionItem);
            });

            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'explanation';
            explanationDiv.innerHTML = `<strong>Объяснение:</strong> ${questionData.explanation}`;
            if (isFinalReview || questionData.selectedAnswer) {
                explanationDiv.style.display = 'block';
            }

            questionCard.appendChild(passageDiv);
            questionCard.appendChild(questionTextDiv);
            questionCard.appendChild(optionsList);
            questionCard.appendChild(explanationDiv);
            
            return questionCard;
        }

        function displayCurrentQuestion() {
            const currentCategoryTitle = categoriesArray[currentCategoryIndex];
            const currentQuestions = allGeneratedQuestions[currentCategoryTitle];

            if (currentQuestions && currentQuestions.length > currentQuestionIndex) {
                let totalQuestionsCount = 0;
                for (let i = 0; i < currentCategoryIndex; i++) {
                    totalQuestionsCount += allGeneratedQuestions[categoriesArray[i]].length;
                }
                const currentQuestionNumber = totalQuestionsCount + currentQuestionIndex + 1;
                
                const questionData = currentQuestions[currentQuestionIndex];
                const questionCard = createQuestionCard(questionData, currentCategoryTitle, currentQuestionNumber);
                
                questionsContainer.innerHTML = '';
                questionsContainer.appendChild(questionCard);
                
                nextBtn.style.display = 'block';
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                endQuiz();
            }
        }
        
        function endQuiz() {
            isQuizActive = false;
            questionsContainer.innerHTML = '';
            
            let totalQuestions = 0;
            const finalScore = score;
            const finalResultsHeader = document.createElement('h2');
            finalResultsHeader.className = 'text-3xl font-bold text-center text-gray-800 mb-6';
            
            const resultsSummary = document.createElement('p');
            resultsSummary.className = 'text-center text-xl font-medium text-gray-700 mb-8';

            const questionsReviewContainer = document.createElement('div');
            questionsReviewContainer.className = 'space-y-6 mt-8';

            for (const categoryTitle of categoriesArray) {
                allGeneratedQuestions[categoryTitle].forEach((q, index) => {
                    totalQuestions++;
                    const questionCard = createQuestionCard(q, categoryTitle, totalQuestions, true);
                    questionsReviewContainer.appendChild(questionCard);
                });
            }
            
            finalResultsHeader.textContent = 'Тест завершен!';
            resultsSummary.textContent = `Ваш результат: ${finalScore} из ${totalQuestions}.`;
            
            questionsContainer.appendChild(finalResultsHeader);
            questionsContainer.appendChild(resultsSummary);
            questionsContainer.appendChild(questionsReviewContainer);

            nextBtn.style.display = 'none';
            startNewTestBtn.style.display = 'block';
        }
        
        generateBtn.addEventListener('click', async () => {
            isQuizActive = true;
            allGeneratedQuestions = {};
            currentCategoryIndex = 0;
            currentQuestionIndex = 0;
            score = 0;

            const difficulty = difficultySelect.value;
            const numCategories = categoriesArray.length;

            for (const [index, categoryTitle] of categoriesArray.entries()) {
                showLoading(`Генерация вопросов для категории: ${categoryTitle} (${index + 1} из ${numCategories})...`);
                const questions = await generateQuestionsForCategory(categoryTitle, difficulty);
                
                if (!questions) {
                    isQuizActive = false;
                    return;
                }
                allGeneratedQuestions[categoryTitle] = questions;
            }
            hideLoading();
            questionsContainer.innerHTML = '';
            displayCurrentQuestion();
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < allGeneratedQuestions[categoriesArray[currentCategoryIndex]].length) {
                displayCurrentQuestion();
            } else {
                currentCategoryIndex++;
                currentQuestionIndex = 0;
                if (currentCategoryIndex < categoriesArray.length) {
                    displayCurrentQuestion();
                } else {
                    endQuiz();
                }
            }
        });
        
        startNewTestBtn.addEventListener('click', () => {
            startNewTestBtn.style.display = 'none';
            questionsContainer.innerHTML = `
                <p class="text-center text-gray-600 text-lg">Нажмите "Сгенерировать вопросы", чтобы начать новый тест.</p>
            `;
        });

    </script>
</body>
</html>
